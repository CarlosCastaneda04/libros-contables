{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Libro Mayor - {{ empresa.nombre }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/libro_mayor.css' %}">

</head>
<body>
  <div class="page">
    <header class="header">
      <h1 class="brand__title">Libro Mayor</h1>
      <p class="brand__subtitle">{{ empresa.nombre }}</p>
      
      <div class="header__line"></div>
    </header>

    <main class="container">
        <div class="nav-wrapper">
        <a class="nav-link" href="{% url 'home' %}">← Menú Principal</a>
      </div>
      <!-- Selector de Empresa -->
      <section class="empresa-selector">
        <h3>Cambiar de Empresa</h3>
        <select id="empresaSelector" onchange="cambiarEmpresa(this.value)">
          <option value="">-- Seleccionar Empresa --</option>
          {% for emp in todas_empresas %}
            <option value="{{ emp.id }}" {% if emp.id == empresa.id %}selected{% endif %}>
              {{ emp.nombre }}
            </option>
          {% endfor %}
        </select>
      </section>

      <!-- Formulario de filtros -->
      <section class="filter-form">
        <h2>Filtrar Libro Mayor</h2>
        <form method="get" action="{% url 'libro_mayor' empresa_id=empresa.id %}">
          <label for="cuenta_id">Seleccionar Cuenta</label>
          <select id="cuenta_id" name="cuenta_id">
            <option value="">Todas las Cuentas</option>
            {% for cuenta in cuentas %}
              <option value="{{ cuenta.codigo }}" {% if request.GET.cuenta_id == cuenta.codigo %}selected{% endif %}>
                {{ cuenta.codigo }} - {{ cuenta.nombre }}
              </option>
            {% endfor %}
          </select>

          <div class="filters-row">
            <div class="filter-col">
              <label for="fecha_inicio">Fecha de Inicio</label>
              <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}">
            </div>
            <div class="filter-col">
              <label for="fecha_fin">Fecha de Fin</label>
              <input type="date" id="fecha_fin" name="fecha_fin" value="{{ request.GET.fecha_fin }}">
            </div>
          </div>

          <div class="filters-actions">
            <button type="submit" class="btn btn-primary">Filtrar</button>
            <a class="btn btn-secondary" href="{% url 'libro_mayor' empresa_id=empresa.id %}">Limpiar Filtros</a>
          </div>
        </form>
      </section>

      <!-- Información de filtros aplicados -->
      {% if request.GET.cuenta_id or request.GET.fecha_inicio or request.GET.fecha_fin %}
        <div class="filters-info">
          <strong>Filtros aplicados:</strong>
          {% if request.GET.cuenta_id %} Cuenta: {{ request.GET.cuenta_id }} |{% endif %}
          {% if request.GET.fecha_inicio %} Desde: {{ request.GET.fecha_inicio }} |{% endif %}
          {% if request.GET.fecha_fin %} Hasta: {{ request.GET.fecha_fin }}{% endif %}
        </div>
      {% endif %}

      <!-- Cuentas y movimientos -->
      {% if datos_mayor %}
        {% for item in datos_mayor %}
          <section class="cuenta-bloque">
            <header class="cuenta-header">
              {{ item.cuenta.codigo }} · {{ item.cuenta.nombre }}
            </header>
            <div class="table-wrap">
              <table class="report-table">
                <thead>
                  <tr>
                    <th class="col-fecha">Fecha</th>
                    <th class="col-descripcion">Descripción</th>
                    <th class="col-numero numero">Debe</th>
                    <th class="col-numero numero">Haber</th>
                    <th class="col-numero numero">Saldo</th>
                  </tr>
                </thead>
                <tbody>
                  {% for mov in item.movimientos %}
                    <tr class="mov-row">
                      <td>{{ mov.fecha|date:"d/m/Y" }}</td>
                      <td>{{ mov.descripcion }}</td>
                      <td class="numero">${{ mov.debe|floatformat:2 }}</td>
                      <td class="numero">${{ mov.haber|floatformat:2 }}</td>
                      <td class="numero">${{ mov.saldo|floatformat:2 }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="saldo-final">
              Saldo Final: <span>${{ item.saldo_final|floatformat:2 }}</span>
            </div>
          </section>
        {% endfor %}
      {% else %}
        <p class="empty">No hay movimientos para mostrar en {{ empresa.nombre }} con los filtros seleccionados.</p>
      {% endif %}
    </main>

    <footer class="footer">
      <small>© {{ now|date:"Y" }} Software Contable · Libro Mayor</small>
    </footer>
  </div>

  <script>
    function cambiarEmpresa(empresaId) {
      if (empresaId) {
        const urlParams = new URLSearchParams(window.location.search);
        const nuevaUrl = `/libro-mayor/${empresaId}/?${urlParams.toString()}`;
        window.location.href = nuevaUrl;
      }
    }
  </script>
</body>
</html>
