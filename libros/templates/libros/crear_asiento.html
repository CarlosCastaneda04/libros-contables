<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ingresar Nuevo Asiento</title>
</head>
<body>
    <h1>Ingresar Nuevo Asiento Contable</h1>
    <form method="post" id="asientoForm">
        {% csrf_token %}
        
        <h2>Datos del Asiento</h2>
        {{ form.as_p }}

        <hr>
        <h2>Movimientos Contables</h2>
        <table id="tablaMovimientos">
            <thead>
                <tr>
                    <th>Cuenta</th>
                    <th>Debe</th>
                    <th>Haber</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <button type="button" id="agregarFila">Agregar Movimiento</button>

        <hr>
        <button type="submit" id="guardarBoton" disabled>Guardar Asiento Completo</button>
        <p id="errorMensaje" style="color: red; display: none;">Debe agregar al menos un movimiento contable.</p>
    </form>

    <script>
        const form = document.getElementById('asientoForm');
        const agregarFilaBoton = document.getElementById('agregarFila');
        const guardarBoton = document.getElementById('guardarBoton');
        const tablaBody = document.querySelector('#tablaMovimientos tbody');
        const errorMensaje = document.getElementById('errorMensaje');

        // Función para verificar si el botón de guardar debe estar activo
        function validarFormulario() {
            if (tablaBody.rows.length > 0) {
                guardarBoton.disabled = false;
                errorMensaje.style.display = 'none';
            } else {
                guardarBoton.disabled = true;
            }
        }

        agregarFilaBoton.addEventListener('click', function() {
            const numFila = tablaBody.rows.length;
            const nuevaFila = tablaBody.insertRow();
            
            // ... (El código para crear las celdas y los inputs es el mismo de antes) ...
            // Celda Cuenta
            const celdaCuenta = nuevaFila.insertCell();
            celdaCuenta.innerHTML = `<input name="movimientos-${numFila}-cuenta" placeholder="Código de cuenta" required>`;

            // Celda Debe
            const celdaDebe = nuevaFila.insertCell();
            const inputDebe = document.createElement('input');
            inputDebe.type = 'number'; inputDebe.step = '0.01'; inputDebe.name = `movimientos-${numFila}-debe`; inputDebe.value = '0';
            
            // Celda Haber
            const celdaHaber = nuevaFila.insertCell();
            const inputHaber = document.createElement('input');
            inputHaber.type = 'number'; inputHaber.step = '0.01'; inputHaber.name = `movimientos-${numFila}-haber`; inputHaber.value = '0';

            // Lógica de bloqueo
            inputDebe.addEventListener('input', function() { /* ... */ });
            inputHaber.addEventListener('input', function() { /* ... */ });

            celdaDebe.appendChild(inputDebe);
            celdaHaber.appendChild(inputHaber);
            
            // Celda Acción
            const celdaAccion = nuevaFila.insertCell();
            celdaAccion.innerHTML = `<button type="button" onclick="eliminarFila(this)">Eliminar</button>`;
            
            validarFormulario(); // Llama a la validación después de agregar una fila
        });

        function eliminarFila(boton) {
            const fila = boton.parentNode.parentNode;
            fila.parentNode.removeChild(fila);
            validarFormulario(); // Llama a la validación después de eliminar una fila
        }

        // Validación al enviar el formulario
        form.addEventListener('submit', function(event) {
            if (tablaBody.rows.length === 0) {
                event.preventDefault(); // Detiene el envío del formulario
                errorMensaje.style.display = 'block';
            }
        });
        
        // Ejecuta la validación al cargar la página por si acaso
        validarFormulario();
    </script>
</body>
</html>