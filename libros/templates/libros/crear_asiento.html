<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ingresar Nuevo Asiento</title>
    <style>
        body { font-family: sans-serif; margin: 40px; }
        .autocomplete-container { position: relative; }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #ddd;
            background-color: white;
            max-height: 150px;
            overflow-y: auto;
            z-index: 99;
            width: 100%;
        }
        .autocomplete-suggestions div { padding: 8px; cursor: pointer; }
        .autocomplete-suggestions div:hover { background-color: #f2f2f2; }
    </style>
</head>
<body>
            <a class="nav-link" href="{% url 'home' %}">Volver al Menú Principal</a>
    <h1>Ingresar Nuevo Asiento Contable</h1>
    <form method="post" id="asientoForm">
        {% csrf_token %}
        
        <h2>Datos del Asiento</h2>
        {{ form.as_p }}

        <hr>
        <h2>Movimientos Contables</h2>
        <table id="tablaMovimientos" data-buscar-url="{% url 'buscar_cuentas' %}">
            <thead>
                <tr>
                    <th>Cuenta</th>
                    <th>Debe</th>
                    <th>Haber</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <button type="button" id="agregarFila">Agregar Movimiento</button>

        <hr>
        <button type="submit" id="guardarBoton" disabled>Guardar Asiento Completo</button>
        <p id="errorMensaje" style="color: red; display: none;">Debe agregar al menos un movimiento contable.</p>
    </form>

    <script>
        const form = document.getElementById('asientoForm');
        const agregarFilaBoton = document.getElementById('agregarFila');
        const guardarBoton = document.getElementById('guardarBoton');
        const tablaBody = document.querySelector('#tablaMovimientos tbody');
        const errorMensaje = document.getElementById('errorMensaje');

        function validarFormulario() {
            guardarBoton.disabled = tablaBody.rows.length === 0;
        }

        agregarFilaBoton.addEventListener('click', function() {
            const numFila = tablaBody.rows.length;
            const nuevaFila = tablaBody.insertRow();
            
            // --- Celda Cuenta (con autocompletado) ---
            const celdaCuenta = nuevaFila.insertCell();
            celdaCuenta.classList.add('autocomplete-container');
            
            const inputVisible = document.createElement('input');
            inputVisible.placeholder = 'Código o nombre de cuenta';
            inputVisible.classList.add('cuenta-autocomplete');
            inputVisible.required = true;

            const inputOculto = document.createElement('input');
            inputOculto.type = 'hidden';
            inputOculto.name = `movimientos-${numFila}-cuenta`;
            
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.classList.add('autocomplete-suggestions');

            celdaCuenta.appendChild(inputVisible);
            celdaCuenta.appendChild(inputOculto);
            celdaCuenta.appendChild(suggestionsDiv);

            inputVisible.addEventListener('input', async function() {
                const term = this.value;
                suggestionsDiv.innerHTML = '';
                if (term.length < 2) return;

                // CAMBIO 2: El JavaScript ahora lee la URL desde la tabla
                const tabla = document.getElementById('tablaMovimientos');
                const buscarUrl = tabla.dataset.buscarUrl;
                const response = await fetch(`${buscarUrl}?term=${term}`);
                const data = await response.json();

                data.forEach(cuenta => {
                    const suggestion = document.createElement('div');
                    suggestion.textContent = cuenta.text;
                    suggestion.addEventListener('click', function() {
                        inputVisible.value = cuenta.text;
                        inputOculto.value = cuenta.id;
                        suggestionsDiv.innerHTML = '';
                    });
                    suggestionsDiv.appendChild(suggestion);
                });
            });
            
            // --- Celdas Debe y Haber ---
            const celdaDebe = nuevaFila.insertCell();
            const inputDebe = document.createElement('input');
            inputDebe.type = 'number'; inputDebe.step = '0.01'; inputDebe.name = `movimientos-${numFila}-debe`; inputDebe.value = '0';
            
            const celdaHaber = nuevaFila.insertCell();
            const inputHaber = document.createElement('input');
            inputHaber.type = 'number'; inputHaber.step = '0.01'; inputHaber.name = `movimientos-${numFila}-haber`; inputHaber.value = '0';
            
            inputDebe.addEventListener('input', function() { if (this.value && parseFloat(this.value) > 0) { inputHaber.disabled = true; inputHaber.value = '0'; } else { inputHaber.disabled = false; } });
            inputHaber.addEventListener('input', function() { if (this.value && parseFloat(this.value) > 0) { inputDebe.disabled = true; inputDebe.value = '0'; } else { inputDebe.disabled = false; } });

            celdaDebe.appendChild(inputDebe);
            celdaHaber.appendChild(inputHaber);
            
            // --- Celda Acción ---
            const celdaAccion = nuevaFila.insertCell();
            celdaAccion.innerHTML = '<button type="button" onclick="eliminarFila(this)">Eliminar</button>';
            
            validarFormulario();
        });

        function eliminarFila(boton) {
            boton.closest('tr').remove();
            validarFormulario();
        }

        form.addEventListener('submit', function(event) {
            if (tablaBody.rows.length === 0) {
                event.preventDefault();
                errorMensaje.style.display = 'block';
            } else {
                errorMensaje.style.display = 'none';
            }
        });
        
        validarFormulario();
    </script>
</body>
</html>